extends ../../../../templates/layout/base

include ../../../../templates/mixins/docsnav

block content
	.container: .row
		
		.col-sm-3
			+docsnav(docssection)
		
		.col-sm-9: .docs-content
			h2 Routes &amp; Views
			
			p Usually, the easiest and clearest way to configure the logic for different routes (or views) in your application is to set up all the bindings single file, then put any common logic (or middleware) in another file.
			p Then, the controller for each route you bind goes in its own file, organised similarly to the template that renders the view.
			p Keystone's <code>importer</code> and Express's middleware support makes this easy to set up.
			
			h3 Setting up your Routes and Middleware
			
			h4 Route index controller
			
			p First, create a <code>routes/index.js</code> file. This is where we bind your application's URL patterns to the controllers that load and process data, and render the appropriate template.
			
			.code-header
				h4 routes/index.js
				p This script imports your route controllers and binds them to URLs.
			pre: code.language-javascript
				| var keystone = require('keystone'),
				|     middleware = require('./middleware'),
				|     importRoutes = keystone.importer(__dirname);
				| 
				| // Common Middleware
				| keystone.pre('routes', middleware.initErrorHandlers);
				| keystone.pre('routes', middleware.initLocals);
				| keystone.pre('render', middleware.flashMessages);
				| 
				| // Handle 404 errors
				| keystone.set('404', function(req, res, next) {
				|     res.notfound();
				| });
				| 
				| // Handle other errors
				| keystone.set('500', function(err, req, res, next) {
				|     var title, message;
				|     if (err instanceof Error) {
				|         message = err.message;
				|         err = err.stack;
				|     }
				|     res.err(err, title, message);
				| });
				| 
				| // Load Routes
				| var routes = {
				|     views: importRoutes('./views')
				| };
				| 
				| // Bind Routes
				| exports = module.exports = function(app) {
				|     
				|     app.get('/', routes.views.index);
				|     
				| }

			h4 Stepping through the route controller index
			
			ul
				li Load <code>keystone</code>, the <code>middleware.js</code> file (below), and create an <code>importer</code> for the current directory
				li Bind middleware (below) that
					ul
						li Initialises our basic error handlers
						li Initialises common local variables for our view templates
						li Retrieves flash messages from session before the view template is rendered
				li Tell Keystone how to handle <code>404</code> and <code>500</code> errors
				li Use the importer to load all the route controllers in the <code>/routes/views</code> directory
				li Export a method that binds the index route controller to <code>GET</code> requests on the root url <code>/</code>
					ul
						li The <code>app</code> argument to this method our express app, so anything you can do binding routes in express, you can do here.
			
			p Additional route controllers that you add to your app should be added using <code>app.get</code>, <code>app.post</code> or <code>app.all</code> under your root controller.
			
			
			a(name="routes_middleware")
			h4 Common Route Middleware
			
			p Putting your common middleware in a separate <code>routes/middleware.js</code> file keeps your route index nice and clean. If your middleware file gets too big, it's a good idea to restructure any significant functionality into custom modules in your projects <code>/lib</code> folder.
			p Now we'll add the basic middleware to get your app up and running with default behaviours:
			
			.code-header
				h4 routes/middleware.js
				p This script includes common middleware for your application routes
			pre: code.language-javascript
				| var _ = require('underscore'),
				|     keystone = require('keystone');
				| 
				| /**
				|     Initialises the standard view locals.
				|     Include anything that should be initialised before route controllers are executed.
				| */
				| exports.initLocals = function(req, res, next) {
				|     
				|     var locals = res.locals;
				|     
				|     locals.user = req.user;
				|     
				|     // Add your own local variables here
				|     
				|     next();
				|     
				| };
				| 
				| /**
				|     Inits the error handler functions into `req`
				| */
				| exports.initErrorHandlers = function(req, res, next) {
				|     
				|     res.err = function(err, title, message) {
				|         res.status(500).render('errors/500', {
				|             err: err,
				|             errorTitle: title,
				|             errorMsg: message
				|         });
				|     }
				|     
				|     res.notfound = function(title, message) {
				|         res.status(404).render('errors/404', {
				|             errorTitle: title,
				|             errorMsg: message
				|         });
				|     }
				|     
				|     next();
				|     
				| };
				| 
				| /**
				|     Fetches and clears the flashMessages before a view is rendered
				| */
				| exports.flashMessages = function(req, res, next) {
				|     
				|     var flashMessages = {
				|         info: req.flash('info'),
				|         success: req.flash('success'),
				|         warning: req.flash('warning'),
				|         error: req.flash('error')
				|     };
				|     
				|     res.locals.messages = _.any(flashMessages, function(msgs) { return msgs.length }) ? flashMessages : false;
				|     
				|     next();
				|     
				| };
			
			h4 Middleware functions
			
			p Keystone expects middleware functions to accept the following arguments:
			ul.options
				li <code>req</code> - an express request object
				li <code>res</code> - an express response object
				li <code>next</code> - the method to call when the middleware has finished running (including any internal callbacks)
			
			h4 Flash message support (no, not that flash)
			
			p Keystone includes support for 'flashing' messages to your visitors via session. The default setup above supports four categories, all of which can be styled differently:
			ul.options
				li <code>info</code>
				li <code>success</code>
				li <code>warning</code>
				li <code>error</code>
			p You can easily support other types of messages by updating your middleware and the .jade template that renders them (which we'll get to below).
			p To use flash messages in your route controllers, do this:
			p: code req.flash('info', 'Some information!');
			p Messages use session so they survive redirects, and will only be displayed to the user once, making them perfect for status messages (e.g. "Your changes have been saved") or form validation (e.g. "Please enter a valid email address").
			p Some Keystone features (such as the Update Handler) can automatically generate flash messages for you, and expect the categories above to be available.
			
			
			a(name="routes_view")
			h3 Your first View
			
			p Now we're going to set up your first route controller (for the index page), and the template it will render.
			
			p The importer (above) expects the directory you ask it for to include <code>.js</code> or <code>.coffee</code> files that export a single method accepting the following arguments:
			ul.options
				li <code>req</code> - an express request object
				li <code>res</code> - an express response object
			
			p Our first view controller is going to be very simple - just rendering a template. Create an <code>routes/views/index.js</code> file like this:
			
			.code-header
				h4 routes/views/index.js
				p The route controller for our home page view
			pre: code.language-javascript
				| var keystone = require('keystone');
				| 
				| exports = module.exports = function(req, res) {
				|     
				|     var view = new keystone.View(req, res);
				|     
				|     view.render('index');
				|     
				| }
			
			a(name="routes_templates")
			h4 Templates
			
			p Now, for the template our route will render. The <code>render</code> method looks in the <code>views</code> directory specified in our <code>web.js</code>, which we set to <code>/templates/views</code>.
			p In this guide, we're going to use <strong>Jade</strong> for our templates. To learn more about Jade, visit <a href="http://jade-lang.com" target="_blank">jade-lang.org</a>, or check out the great <a href="http://naltatis.github.io/jade-syntax-docs/" target="_blank">live syntax documentation</a> to learn by example.
			p First up, create <code>templates/views/index.jade</code>:

			.code-header
				h4 templates/views/index.jade
				p The template for our home page view
			pre
				| extends ../layouts/base
				| 
				| block content
				|     h1 Hello World
			
			p Jade comes with some great features to simplify templates - including using layouts that define regions. We're going to use a layout called <code>templates/layout/base.jade</code>, which is included on the first line of the file above:
			
			.code-header
				h4 templates/layouts/base.jade
				p The base layout for our view templates
			pre: code
				| include ../mixins/flash-messages
				| 
				| doctype html
				| html
				|     head
				|         meta(charset="utf-8")
				|         meta(name="viewport", content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width")
				|         
				|         title= title || 'My Keystone Website'
				|         link(rel="shortcut icon", href="/favicon.ico", type="image/x-icon")
				|         link(href="/styles/site.min.css", rel="stylesheet")
				|         
				|         block css
				|         block head
				|     body
				|         
				|         #header My Keystone Website
				|         
				|         #body
				|             
				|             block intro
				|             
				|             +flash-messages(messages)
				|             
				|             block content
				|         
				|         #footer Powered by &lt;a href='http://keystonejs.com', target='_blank'&gt;KeystoneJS&lt;/a&gt;.
				|     
				|     script(src='/js/lib/jquery/jquery-1.10.2.min.js')
				|     
				|     block js
			
			p We're also going to create a <code>templates/mixins/flash-messages.jade</code> template to include the <code>flash-messages</code> mixin. Including mixins in your layout or view templates is a great way to keep your layout and view files clean, and re-use mixins across multiple views.
			
			.code-header
				h4 templates/mixins/flash-messages.jade
				p Our flash-messages mixin
			pre: code
				| mixin flash-messages(messages)
				|     if messages
				|         #flash-messages.container
				|             each message in messages.info
				|                 +flash-message(message, 'info')
				|             each message in messages.success
				|                 +flash-message(message, 'success')
				|             each message in messages.warning
				|                 +flash-message(message, 'warning')
				|             each message in messages.error
				|                 +flash-message(message, 'danger')
				|                 
				| mixin flash-message(message, type)
				|     div(class='alert alert-' + type)
				|         if utils.isObject(message)
				|             if message.title
				|                 h4= message.title
				|             if message.detail
				|                 p= message.detail
				|             if message.list
				|                 ul
				|                     each item in message.list
				|                         li= item
				|         else
				|             = message
			
			.contextual-note
				h4 Using other template languages
				p KeystoneJS supports <a href='http://expressjs.com/api.html#app.engine'>any template language supported by express</a>.
				p Use the <code>view engine</code> option to specify the template language you want to use (it will default to <code class="data-type">jade</code>).
				p If you want to use a custom template engine, set the <code>custom engine</code> option as well. For instance, <a href="http://embeddedjs.com/">ejs</a> is supported by express by default, but you might want to use <a href="https://github.com/RandomEtc/ejs-locals">ejs.locals</a> as a template engine in order to benefit from get extensions.

				pre: code.language-javascript
					| // Modified web.js to use the ejs-locals custom template engine.
					| var keystone = require('keystone');
					| var engine   = require('ejs-locals');
					| keystone.init({
					|   ...
					|   'custom engine': engine,
					|   'view engine': 'ejs',
					|   ...
					| });
			
			
			a(name="routes_public")
			h4 Public Assets
			
			p You'll want to add your own css, javascript, images and other files to your project. In the examples above, we're including <code>/styles/site.min.css</code> and <code>/js/lib/jquery-1.10.2.min.js</code>.
			p Keystone will serve any static assets you place in the <code>public</code> directory. This path is specified in <code>web.js</code> by the <code>static</code> option.
			p It will also automatically generate <code>.css</code> or compressed <code>.min.css</code> files when a corresponding <code>.less</code> file is found in the <code>public</code> folder, as specified in <code>web.js</code> by the <code>less</code> option. For more information on LESS, see <a href="http://lesscss.org" target="_blank">lesscss.org</a>.
		
			.simple-pager
				a(href='/docs/guides/getting-started/running-your-app').btn.btn-default.next Running your App &rarr;
				a(href='/docs/guides/getting-started/models').btn.btn-default.prev &larr; Models

